# Managing State in Autogen: Saving and Loading Agent Conversations

## Setup and Requirements

```python
import os
import getpass
import json
from autogen_agentchat.agents import AssistantAgent
from autogen_agentchat.conditions import MaxMessageTermination
from autogen_agentchat.messages import TextMessage
from autogen_agentchat.teams import RoundRobinGroupChat
from autogen_agentchat.ui import Console
from autogen_core import CancellationToken
from autogen_ext.models.openai import OpenAIChatCompletionClient

def _set_env(var: str):
    if not os.environ.get(var):
        os.environ[var] = getpass.getpass(f"{var}: ")

_set_env("OPENAI_API_KEY")
```

## Introduction to State Management
In multi-agent applications, preserving the context and history of conversations is crucial. State management in Autogen allows us to save and restore agent memories, team configurations, and conversation histories.

## Managing Individual Agent State

```python
# Create a movie critic agent
critic_agent = AssistantAgent(
    name="critic_agent",
    system_message="You are a passionate movie critic who analyzes films deeply",
    model_client=OpenAIChatCompletionClient(
        model="gpt-4-0125-preview",
    ),
)

# Have a conversation about a movie
response = await critic_agent.on_messages(
    [TextMessage(content="Review the cinematography of Blade Runner 2049", source="user")], 
    CancellationToken()
)

# Save the agent's state after the review
agent_state = await critic_agent.save_state()

# Create a new instance of the critic agent
new_critic_agent = AssistantAgent(
    name="critic_agent",
    system_message="You are a passionate movie critic who analyzes films deeply",
    model_client=OpenAIChatCompletionClient(
        model="gpt-4-0125-preview",
    ),
)

# Load the previous conversation state
await new_critic_agent.load_state(agent_state)

# Ask about the previous review
response = await new_critic_agent.on_messages(
    [TextMessage(content="What were the main points of your previous cinematography analysis?", source="user")], 
    CancellationToken()
)
```

## Managing Team State

```python
# Create a film analysis team
critic_agent = AssistantAgent(
    name="critic_agent",
    system_message="You are a passionate movie critic who analyzes films deeply",
    model_client=OpenAIChatCompletionClient(
        model="gpt-4-0125-preview",
    ),
)

film_team = RoundRobinGroupChat(
    [critic_agent], 
    termination_condition=MaxMessageTermination(max_messages=3)
)

# Run an analysis session
stream = film_team.run_stream(
    task="Analyze the themes of isolation in Taxi Driver"
)
await Console(stream)

# Save the team's state
team_state = await film_team.save_state()

# Create a new team instance
new_film_team = RoundRobinGroupChat(
    [critic_agent], 
    termination_condition=MaxMessageTermination(max_messages=3)
)

# Load the previous analysis session
await new_film_team.load_state(team_state)

# Ask about the previous analysis
stream = new_film_team.run_stream(
    task="What was your main conclusion about isolation in the previous analysis?"
)
await Console(stream)
```

## Persistent Storage

```python
# Save team state to a file
def save_team_state(team_state, filename):
    with open(filename, "w") as f:
        json.dump(team_state, f)

# Load team state from a file
def load_team_state(filename):
    with open(filename, "r") as f:
        return json.load(f)

# Example usage
filename = "film_analysis_session.json"

# Save the state
save_team_state(team_state, filename)

# Create a new team and restore the state
new_team = RoundRobinGroupChat(
    [critic_agent], 
    termination_condition=MaxMessageTermination(max_messages=3)
)
saved_state = load_team_state(filename)
await new_team.load_state(saved_state)

# Continue the analysis
stream = new_team.run_stream(
    task="How does the theme of isolation connect to the visual style discussed earlier?"
)
await Console(stream)
```

## Key Points to Remember

1. Agent state primarily consists of conversation history and context
2. Team state includes all member agents' states plus team-specific configurations
3. States can be serialized to JSON for persistent storage
4. Loaded states allow agents to maintain conversation context
5. State management is crucial for building stateless applications

## Common Use Cases
- Web applications requiring conversation persistence
- Long-running analysis sessions that need to be resumed
- Multi-step processes that require context preservation
- Distributed systems where state needs to be shared
- Backup and recovery of agent conversations